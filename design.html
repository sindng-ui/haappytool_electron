<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HappyTool - Developer Suite</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Global Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
            border: 2px solid #0f172a;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0f172a;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .animate-fade-in-down {
            animation: fadeDown 0.3s ease-out forwards;
        }

        /* Selection Color */
        ::selection {
            background-color: rgba(99, 102, 241, 0.3);
            color: #e2e8f0;
        }

        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
    </style>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 950: '#020617' }
                    }
                }
            }
        }
    </script>

    <!-- Import Map: STRICTLY React 18 ONLY from esm.sh to avoid version conflicts -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/"
  }
}
</script>

    <!-- Babel for in-browser JSX/TSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="/index.css">
</head>

<body class="bg-slate-950 text-slate-200 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <!-- MAIN APPLICATION SCRIPT -->
    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import React, { useState, useEffect, useRef, useMemo, useCallback, useImperativeHandle, forwardRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import {
            FileText, Activity, Archive, Smile, Braces,
            Upload, Plus, Trash2, Copy, Download, X, Sparkles, Zap, ShieldAlert, Save,
            Highlighter, RotateCcw, Columns, Maximize, Check, AlertCircle,
            ChevronLeft, ChevronRight, Palette,
            Send, ArrowRight, Clock, Globe, Database,
            CheckCircle, FileDown, Cog, Box,
            GitCompare, AlignLeft, Minimize2, FileJson, ArrowRightLeft, GripVertical, Bookmark, Split, CornerDownRight, FolderOpen
        } from 'lucide-react';

        // --- UTILS ---
        const saveFileWithPicker = async (content, defaultName, type = 'text/plain') => {
            try {
                if ('showSaveFilePicker' in window) {
                    // @ts-ignore
                    const handle = await window.showSaveFilePicker({
                        suggestedName: defaultName,
                        types: [{
                            description: 'File',
                            accept: { [type]: ['.txt', '.json', '.log', '.tpk'] },
                        }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(content);
                    await writable.close();
                } else {
                    const blob = new Blob([content], { type });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = defaultName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            } catch (err) {
                // @ts-ignore
                if (err.name !== 'AbortError') {
                    console.error('File save failed:', err);
                    alert('Failed to save file.');
                }
            }
        };

        // --- TYPES & ENUMS ---
        const ToolId = {
            LOG_EXTRACTOR: 'LOG_EXTRACTOR',
            PERF_ANALYZER: 'PERF_ANALYZER',
            TPK_EXTRACTOR: 'TPK_EXTRACTOR',
            JSON_TOOLS: 'JSON_TOOLS',
        };

        // --- COMPONENTS ---

        // 1. Sidebar Component
        const Sidebar = ({ activeTool, onSelectTool, toolOrder, onReorderTools }) => {
            const [isHovered, setIsHovered] = useState(false);
            const [draggedItem, setDraggedItem] = useState(null);

            const toolDefinitions = {
                [ToolId.LOG_EXTRACTOR]: { label: 'Log Extractor', icon: FileText },
                [ToolId.PERF_ANALYZER]: { label: 'Perf Analyzer', icon: Activity },
                [ToolId.JSON_TOOLS]: { label: 'JSON Tools', icon: Braces },
                [ToolId.TPK_EXTRACTOR]: { label: 'Tpk Extractor', icon: Archive },
            };

            const handleDragStart = (e, id) => {
                setDraggedItem(id);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragEnd = () => setDraggedItem(null);
            const handleDragOver = (e) => e.preventDefault();
            const handleDragEnter = (e, targetId) => {
                e.preventDefault();
                if (!draggedItem || draggedItem === targetId) return;
                const currentIndex = toolOrder.indexOf(draggedItem);
                const targetIndex = toolOrder.indexOf(targetId);
                if (currentIndex === -1 || targetIndex === -1) return;
                const newOrder = [...toolOrder];
                newOrder.splice(currentIndex, 1);
                newOrder.splice(targetIndex, 0, draggedItem);
                onReorderTools(newOrder);
            };

            return (
                <div
                    className={`h-full bg-slate-950 border-r border-slate-800 text-slate-400 transition-all duration-300 ease-in-out flex flex-col z-30 shadow-2xl ${isHovered ? 'w-72' : 'w-20'
                        }`}
                    onMouseEnter={() => setIsHovered(true)}
                    onMouseLeave={() => setIsHovered(false)}
                >
                    <div className="h-20 flex items-center justify-center relative border-b border-slate-900/50">
                        <div className={`transition-all duration-300 ${isHovered ? 'scale-100' : 'scale-90'}`}>
                            {isHovered ? (
                                <div className="flex items-center gap-2 text-indigo-400">
                                    <Smile className="w-8 h-8" strokeWidth={2.5} />
                                    <span className="font-bold text-2xl tracking-tight text-white">HappyTool</span>
                                </div>
                            ) : (
                                <div className="bg-indigo-600 p-2 rounded-xl shadow-lg shadow-indigo-900/20">
                                    <Smile className="w-6 h-6 text-white" />
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="flex-1 px-3 py-6 space-y-2 overflow-y-auto overflow-x-hidden">
                        {toolOrder.map((toolId) => {
                            const item = toolDefinitions[toolId];
                            if (!item) return null;
                            const Icon = item.icon;
                            const isActive = activeTool === toolId;
                            const isDragging = draggedItem === toolId;

                            return (
                                <button
                                    key={toolId}
                                    draggable="true"
                                    onDragStart={(e) => handleDragStart(e, toolId)}
                                    onDragEnd={handleDragEnd}
                                    onDragOver={handleDragOver}
                                    onDragEnter={(e) => handleDragEnter(e, toolId)}
                                    onClick={() => onSelectTool(toolId)}
                                    className={`w-full flex items-center h-12 px-3 rounded-2xl transition-all duration-300 ease-out group relative cursor-pointer ${isActive
                                            ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50'
                                            : 'text-slate-400 hover:bg-slate-900 hover:text-slate-200'
                                        } ${isDragging ? 'opacity-20 border-2 border-dashed border-slate-600' : ''}`}
                                >
                                    {isHovered && (
                                        <div className="absolute left-1 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-30 cursor-grab active:cursor-grabbing">
                                            <GripVertical size={14} />
                                        </div>
                                    )}
                                    <div className="min-w-[40px] flex items-center justify-center">
                                        <Icon className={`w-6 h-6 transition-transform duration-200 ${isActive ? 'scale-110' : 'group-hover:scale-110'}`} />
                                    </div>
                                    <span className={`ml-3 font-medium text-sm whitespace-nowrap transition-all duration-300 ${isHovered ? 'opacity-100 translate-x-0' : 'opacity-0 -translate-x-4 hidden'}`}>
                                        {item.label}
                                    </span>
                                    {!isHovered && !isDragging && (
                                        <div className="absolute left-full ml-4 px-3 py-1.5 bg-slate-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity whitespace-nowrap z-50 shadow-xl border border-slate-700">
                                            {item.label}
                                            <div className="absolute left-0 top-1/2 -translate-x-1 -translate-y-1/2 w-2 h-2 bg-slate-800 rotate-45 border-l border-b border-slate-700"></div>
                                        </div>
                                    )}
                                </button>
                            );
                        })}
                    </div>

                    <div className={`p-6 border-t border-slate-900 text-xs text-slate-600 whitespace-nowrap overflow-hidden transition-opacity duration-200 ${isHovered ? 'opacity-100' : 'opacity-0'}`}>
                        <div className="flex flex-col gap-1">
                            <span className="font-bold text-slate-500">HappyTool Suite</span>
                            <span>v0.0.2 &bull; Build 2025</span>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Log Extractor Sub-Components
        const HIGHLIGHT_COLORS = [
            { label: 'Yellow', value: 'bg-yellow-200' },
            { label: 'Red', value: 'bg-red-200' },
            { label: 'Green', value: 'bg-green-200' },
            { label: 'Blue', value: 'bg-blue-200' },
            { label: 'Purple', value: 'bg-purple-200' },
            { label: 'Orange', value: 'bg-orange-200' },
            { label: 'Light Red', value: 'bg-red-100' },
        ];
        const ROW_HEIGHT = 24;
        const OVERSCAN = 10;

        const LogViewerPane = React.memo(forwardRef(({ fileData, onFileChange, selectedRule, placeholderText, hotkeyScope, onSyncScroll, isRawMode, initialScrollLine, onRowDoubleClick }, ref) => {
            const [dragActive, setDragActive] = useState(false);
            const [scrollTop, setScrollTop] = useState(0);
            const [viewportHeight, setViewportHeight] = useState(0);
            const [activeLineIndex, setActiveLineIndex] = useState(-1);
            const [bookmarks, setBookmarks] = useState(new Set());
            const scrollViewportRef = useRef(null);

            const filteredData = useMemo(() => {
                if (!fileData.content) return [];
                const lines = fileData.content.split('\n');
                if (isRawMode || !selectedRule) return lines.map((line, index) => ({ matchId: index + 1, lineNum: index + 1, text: line, originalIndex: index }));
                const activeGroups = selectedRule.includeGroups.map(g => g.filter(t => t.trim() !== ''));
                const meaningfulGroups = activeGroups.filter(g => g.length > 0);
                const excludes = selectedRule.excludes.filter(e => e.trim() !== '');
                const results = [];
                let matchCounter = 0;
                lines.forEach((line, index) => {
                    const hasExclude = excludes.some(exc => line.includes(exc));
                    if (hasExclude) return;
                    let isMatch = false;
                    if (meaningfulGroups.length === 0) isMatch = true;
                    else isMatch = meaningfulGroups.some(group => group.every(term => line.includes(term)));
                    if (isMatch) {
                        matchCounter++;
                        results.push({ matchId: matchCounter, lineNum: index + 1, text: line, originalIndex: index });
                    }
                });
                return results;
            }, [fileData.content, selectedRule, isRawMode]);

            const { virtualItems, totalHeight, offsetY } = useMemo(() => {
                const totalCount = filteredData.length;
                const totalHeight = totalCount * ROW_HEIGHT;
                const startIndex = Math.max(0, Math.floor(scrollTop / ROW_HEIGHT) - OVERSCAN);
                const visibleCount = Math.ceil(viewportHeight / ROW_HEIGHT);
                const endIndex = Math.min(totalCount - 1, startIndex + visibleCount + (OVERSCAN * 2));
                const virtualItems = filteredData.slice(startIndex, endIndex + 1).map((item, index) => ({ ...item, absoluteIndex: startIndex + index }));
                const offsetY = startIndex * ROW_HEIGHT;
                return { virtualItems, totalHeight, offsetY };
            }, [filteredData, scrollTop, viewportHeight]);

            useEffect(() => {
                if (!fileData.content || !scrollViewportRef.current) return;
                const observer = new ResizeObserver((entries) => { for (const entry of entries) setViewportHeight(entry.contentRect.height); });
                observer.observe(scrollViewportRef.current);
                return () => observer.disconnect();
            }, [fileData.content]);

            useEffect(() => {
                if (initialScrollLine !== undefined && initialScrollLine !== -1 && scrollViewportRef.current && filteredData.length > 0) {
                    const targetIndex = filteredData.findIndex(d => d.lineNum === initialScrollLine + 1);
                    if (targetIndex !== -1) {
                        setActiveLineIndex(targetIndex);
                        setTimeout(() => { if (scrollViewportRef.current) scrollViewportRef.current.scrollTop = targetIndex * ROW_HEIGHT - (viewportHeight / 2) + (ROW_HEIGHT / 2); }, 0);
                    }
                }
            }, [initialScrollLine, filteredData.length, viewportHeight]);

            useEffect(() => {
                if (activeLineIndex !== -1 && scrollViewportRef.current) {
                    const lineTop = activeLineIndex * ROW_HEIGHT;
                    const lineBottom = lineTop + ROW_HEIGHT;
                    const viewTop = scrollTop;
                    const viewBottom = viewTop + viewportHeight;
                    if (lineTop < viewTop) scrollViewportRef.current.scrollTop = lineTop;
                    else if (lineBottom > viewBottom) scrollViewportRef.current.scrollTop = lineBottom - viewportHeight;
                }
            }, [activeLineIndex]);

            useImperativeHandle(ref, () => ({
                scrollBy: (deltaY) => { if (scrollViewportRef.current) scrollViewportRef.current.scrollTop += deltaY; },
                jumpToNextBookmark: () => {
                    const sorted = Array.from(bookmarks).sort((a, b) => a - b);
                    const next = sorted.find(idx => idx > activeLineIndex);
                    const target = next !== undefined ? next : (sorted.length > 0 ? sorted[0] : undefined);
                    if (target !== undefined) { setActiveLineIndex(target); if (scrollViewportRef.current) scrollViewportRef.current.scrollTop = target * ROW_HEIGHT - (viewportHeight / 2); }
                },
                jumpToPrevBookmark: () => {
                    const sorted = Array.from(bookmarks).sort((a, b) => a - b);
                    const prev = sorted.reverse().find(idx => idx < activeLineIndex);
                    const target = prev !== undefined ? prev : (sorted.length > 0 ? sorted[0] : undefined);
                    if (target !== undefined) { setActiveLineIndex(target); if (scrollViewportRef.current) scrollViewportRef.current.scrollTop = target * ROW_HEIGHT - (viewportHeight / 2); }
                }
            }));

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (hotkeyScope === 'none') return;
                    let isScoped = false;
                    if (hotkeyScope === 'ctrl' && e.ctrlKey && !e.altKey) isScoped = true;
                    if (hotkeyScope === 'alt' && e.altKey && !e.ctrlKey) isScoped = true;
                    if (isScoped && e.key >= '1' && e.key <= '5') {
                        e.preventDefault();
                        const index = parseInt(e.key) - 1;
                        const keyword = selectedRule?.highlights?.[index]?.keyword;
                        if (!keyword || filteredData.length === 0) return;
                        const currentTopIndex = Math.floor(scrollTop / ROW_HEIGHT);
                        let nextMatchIndex = filteredData.findIndex((item, idx) => idx > currentTopIndex && item.text.includes(keyword));
                        if (nextMatchIndex === -1) nextMatchIndex = filteredData.findIndex(item => item.text.includes(keyword));
                        if (nextMatchIndex !== -1) setActiveLineIndex(nextMatchIndex);
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selectedRule, filteredData, scrollTop, hotkeyScope, activeLineIndex]);

            const onKeyDownDiv = (e) => {
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (activeLineIndex !== -1) {
                        setBookmarks(prev => {
                            const next = new Set(prev);
                            if (next.has(activeLineIndex)) next.delete(activeLineIndex); else next.add(activeLineIndex);
                            return next;
                        });
                    }
                }
                if (!e.shiftKey) {
                    if (e.key === 'ArrowUp') { e.preventDefault(); setActiveLineIndex(prev => Math.max(0, prev - 1)); }
                    if (e.key === 'ArrowDown') { e.preventDefault(); setActiveLineIndex(prev => Math.min(filteredData.length - 1, prev + 1)); }
                }
                if (e.shiftKey) {
                    if (e.key === 'ArrowUp') { e.preventDefault(); setActiveLineIndex(prev => Math.max(0, prev - 1)); if (onSyncScroll) onSyncScroll(-ROW_HEIGHT); }
                    if (e.key === 'ArrowDown') { e.preventDefault(); setActiveLineIndex(prev => Math.min(filteredData.length - 1, prev + 1)); if (onSyncScroll) onSyncScroll(ROW_HEIGHT); }
                }
            };

            useEffect(() => {
                const div = scrollViewportRef.current;
                if (!div) return;
                const handleWheelNative = (e) => {
                    if (e.shiftKey) { e.preventDefault(); const delta = e.deltaY !== 0 ? e.deltaY : e.deltaX; div.scrollTop += delta; if (onSyncScroll) onSyncScroll(delta); }
                };
                div.addEventListener('wheel', handleWheelNative, { passive: false });
                return () => div.removeEventListener('wheel', handleWheelNative);
            }, [onSyncScroll]);

            const handleDrag = useCallback((e) => { e.preventDefault(); e.stopPropagation(); if (e.type === 'dragenter' || e.type === 'dragover') setDragActive(true); else if (e.type === 'dragleave') setDragActive(false); }, []);
            const handleDrop = useCallback((e) => {
                e.preventDefault(); e.stopPropagation(); setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    const file = e.dataTransfer.files[0];
                    const reader = new FileReader();
                    reader.onload = (ev) => { onFileChange(file.name, ev.target?.result); if (scrollViewportRef.current) scrollViewportRef.current.scrollTop = 0; setScrollTop(0); setBookmarks(new Set()); };
                    reader.readAsText(file);
                }
            }, [onFileChange]);

            const renderHighlightedText = (text, highlights) => {
                if (!highlights || highlights.length === 0) return text;
                const validHighlights = highlights.filter(h => h.keyword.trim() !== '');
                if (validHighlights.length === 0) return text;
                const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const pattern = new RegExp(`(${validHighlights.map(h => escapeRegExp(h.keyword)).join('|')})`, 'g');
                const parts = text.split(pattern);
                return parts.map((part, i) => {
                    const highlight = validHighlights.find(h => h.keyword === part);
                    if (highlight) {
                        const isHex = highlight.color.startsWith('#');
                        const style = isHex ? { backgroundColor: highlight.color } : undefined;
                        const className = `text-slate-900 rounded-sm px-0.5 font-bold ${!isHex ? highlight.color : ''}`;
                        return <span key={i} className={className} style={style}>{part}</span>;
                    }
                    return part;
                });
            };

            const copyToClipboard = () => { navigator.clipboard.writeText(filteredData.map(d => d.text).join('\n')); alert('Copied logs to clipboard!'); };
            const saveToFile = async () => { const textContent = filteredData.map(d => d.text).join('\n'); saveFileWithPicker(textContent, `extracted_${fileData.name || 'log'}.txt`); };

            return (
                <div
                    className={`flex-1 flex flex-col relative overflow-hidden transition-colors border-r border-slate-900 last:border-r-0 ${dragActive ? 'bg-indigo-900/10 ring-4 ring-inset ring-indigo-500/50' : 'bg-slate-950'} ${isRawMode ? 'bg-slate-900' : ''}`}
                    onDragEnter={handleDrag} onDragOver={handleDrag} onDragLeave={handleDrag} onDrop={handleDrop}
                    tabIndex={0} onKeyDown={onKeyDownDiv}
                >
                    <div className={`h-12 border-b border-slate-800 flex items-center justify-between px-3 shrink-0 z-10 group/toolbar ${isRawMode ? 'bg-indigo-950/30' : 'bg-slate-950/50'}`}>
                        <div className="flex items-center gap-3 overflow-hidden">
                            <div className={`p-1.5 rounded-md ${fileData.content ? (isRawMode ? 'bg-orange-500/10 text-orange-400' : 'bg-indigo-500/10 text-indigo-400') : 'bg-slate-800 text-slate-600'}`}>{isRawMode ? <Split size={14} /> : <Zap size={14} />}</div>
                            <div className="flex flex-col min-w-0"><span className="font-bold text-xs text-slate-300 truncate max-w-[300px]">{fileData.name || 'Empty'} {isRawMode ? '(Raw Context View)' : ''}</span></div>
                        </div>
                        <div className="flex items-center gap-1 opacity-50 group-hover/toolbar:opacity-100 transition-opacity">
                            <button onClick={() => onFileChange('', null)} disabled={!fileData.content || isRawMode} className="p-1.5 text-slate-400 hover:text-red-400 hover:bg-red-500/10 rounded transition-colors disabled:invisible" title="Reset"><RotateCcw size={14} /></button>
                            <button onClick={copyToClipboard} disabled={!fileData.content} className="p-1.5 text-slate-400 hover:text-indigo-400 hover:bg-indigo-500/10 rounded transition-colors disabled:invisible" title="Copy"><Copy size={14} /></button>
                            <button onClick={saveToFile} disabled={!fileData.content} className="p-1.5 text-slate-400 hover:text-indigo-400 hover:bg-indigo-500/10 rounded transition-colors disabled:invisible" title="Save"><Download size={14} /></button>
                            {isRawMode && <div className="text-[10px] text-slate-500 ml-2 font-mono">Press ESC to close</div>}
                        </div>
                    </div>
                    <div className="flex-1 relative overflow-hidden">
                        {fileData.content ? (
                            <div ref={scrollViewportRef} onScroll={(e) => setScrollTop(e.currentTarget.scrollTop)} className="absolute inset-0 overflow-y-auto overflow-x-auto custom-scrollbar">
                                <div style={{ height: totalHeight, position: 'relative' }}>
                                    {virtualItems.map(({ matchId, lineNum, text, absoluteIndex, originalIndex }, index) => {
                                        const top = offsetY + (index * ROW_HEIGHT);
                                        const isActive = absoluteIndex === activeLineIndex;
                                        const isBookmarked = bookmarks.has(absoluteIndex);
                                        return (
                                            <div key={matchId} style={{ top, height: ROW_HEIGHT }} onClick={() => setActiveLineIndex(absoluteIndex)} onDoubleClick={() => onRowDoubleClick && onRowDoubleClick(originalIndex, fileData.content || '')}
                                                className={`absolute left-0 min-w-full w-max flex items-center px-4 font-mono text-xs text-slate-400 border-b whitespace-pre transition-colors duration-100 cursor-pointer ${isActive ? 'bg-indigo-500/30 border-indigo-500/50 z-10' : isBookmarked ? 'bg-blue-900/20 border-blue-900/30' : 'border-slate-900/30 hover:bg-slate-800/30'}`}
                                            >
                                                {isBookmarked && <div className="absolute left-1 text-blue-400"><Bookmark size={10} fill="currentColor" /></div>}
                                                <span className="w-10 text-indigo-400/70 select-none text-right pr-2 shrink-0 border-r border-slate-800 mr-2 font-bold">#{matchId}</span>
                                                <span className="w-12 text-slate-500 select-none text-right pr-4 shrink-0 font-medium">{lineNum}</span>
                                                <span>{isRawMode ? text : renderHighlightedText(text, selectedRule?.highlights || [])}</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ) : (
                            <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-600 pointer-events-none select-none">
                                <div className={`p-6 rounded-full border-2 border-dashed border-slate-800 mb-4 transition-transform duration-300 ${dragActive ? 'scale-110 border-indigo-500 bg-indigo-500/10' : ''}`}><Upload size={32} className={dragActive ? 'text-indigo-400' : 'text-slate-700'} /></div>
                                <p className="text-sm font-medium text-slate-500">{placeholderText}</p>
                                <p className="text-xs text-slate-600 mt-2">{!isRawMode && (hotkeyScope === 'ctrl' ? 'Hotkeys: Ctrl + 1~5' : 'Hotkeys: Alt + 1~5')}</p>
                            </div>
                        )}
                    </div>
                    {fileData.content && (
                        <div className="bg-slate-950 border-t border-slate-900 px-3 py-1 text-[10px] text-slate-600 font-mono flex justify-between">
                            <div className="flex gap-4"><span>Lines: {fileData.content.split('\n').length}</span><span>Matches: {filteredData.length}</span></div>
                            <div className="flex gap-2 text-indigo-400">{activeLineIndex !== -1 && <span>Ln {filteredData[activeLineIndex]?.lineNum}</span>}{bookmarks.size > 0 && <span><Bookmark size={10} className="inline" /> {bookmarks.size}</span>}</div>
                        </div>
                    )}
                </div>
            );
        }));

        const LogExtractor = ({ rules, onUpdateRules, onExportSettings, onImportSettings }) => {
            const [selectedRuleId, setSelectedRuleId] = useState(rules.length > 0 ? rules[0].id : '');
            const [isDualView, setIsDualView] = useState(false);
            const [isPanelOpen, setIsPanelOpen] = useState(true);
            const [fileLeft, setFileLeft] = useState({ name: '', content: null });
            const [fileRight, setFileRight] = useState({ name: '', content: null });
            const [contextView, setContextView] = useState(null);
            const [newHighlightWord, setNewHighlightWord] = useState('');
            const [newHighlightColor, setNewHighlightColor] = useState(HIGHLIGHT_COLORS[0].value);
            const fileInputRef = useRef(null);
            const highlightInputRef = useRef(null);
            const [editingTag, setEditingTag] = useState(null);
            const leftPaneRef = useRef(null);
            const rightPaneRef = useRef(null);

            const updateCurrentRule = (updates) => {
                const updatedRules = rules.map(r => r.id === selectedRuleId ? { ...r, ...updates } : r);
                onUpdateRules(updatedRules);
            };

            const handleCreateRule = () => {
                const newId = crypto.randomUUID();
                const newRule = { id: newId, name: 'New Analysis', includeGroups: [['']], excludes: [], highlights: [] };
                onUpdateRules([...rules, newRule]);
                setSelectedRuleId(newId);
                if (!isPanelOpen) setIsPanelOpen(true);
            };

            const handleDeleteRule = () => {
                const updated = rules.filter(r => r.id !== selectedRuleId);
                onUpdateRules(updated);
                setSelectedRuleId(updated.length > 0 ? updated[0].id : '');
            };

            const handleImportFile = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try { onImportSettings(JSON.parse(event.target?.result)); alert('Settings imported!'); }
                    catch (error) { alert('Failed to parse settings file.'); }
                };
                reader.readAsText(file);
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const handleSyncScroll = (deltaY) => {
                if (leftPaneRef.current) leftPaneRef.current.scrollBy(deltaY);
                if (rightPaneRef.current) rightPaneRef.current.scrollBy(deltaY);
            };

            const handleRowDoubleClick = (originalIndex, content) => {
                setContextView({ isOpen: true, content: content, name: 'Raw Context', targetLine: originalIndex });
            };

            useEffect(() => {
                const handleGlobalKeyDown = (e) => {
                    if (e.key === 'Escape' && contextView?.isOpen) setContextView(null);
                    if (!e.shiftKey) {
                        if (e.code === 'F3') { e.preventDefault(); leftPaneRef.current?.jumpToNextBookmark(); }
                        if (e.code === 'F4') { e.preventDefault(); leftPaneRef.current?.jumpToPrevBookmark(); }
                    }
                    if (e.shiftKey) {
                        if (e.code === 'F3') { e.preventDefault(); rightPaneRef.current?.jumpToNextBookmark(); }
                        if (e.code === 'F4') { e.preventDefault(); rightPaneRef.current?.jumpToPrevBookmark(); }
                    }
                };
                window.addEventListener('keydown', handleGlobalKeyDown);
                return () => window.removeEventListener('keydown', handleGlobalKeyDown);
            }, [contextView]);

            const isHexColor = (color) => color.startsWith('#');
            const currentConfig = rules.find(r => r.id === selectedRuleId);

            const groupedRoots = useMemo(() => {
                if (!currentConfig) return [];
                const groups = new Map();
                currentConfig.includeGroups.forEach((group, idx) => {
                    const root = group[0] || '';
                    if (!groups.has(root)) groups.set(root, []);
                    groups.get(root).push(idx);
                });
                return Array.from(groups.entries());
            }, [currentConfig]);

            return (
                <div className="flex h-full flex-col">
                    <div className="bg-slate-900/80 backdrop-blur-sm border-b border-indigo-900/30 p-4 flex items-center justify-between shrink-0 h-16 z-20">
                        <div className="flex items-center gap-6">
                            <div className="flex items-center space-x-4">
                                <div className="p-2 bg-indigo-500/10 rounded-lg border border-indigo-500/20"><Sparkles size={18} className="text-indigo-400" /></div>
                                <select className="border-none bg-transparent font-bold text-slate-200 text-lg focus:outline-none cursor-pointer hover:text-indigo-400 transition-colors [&>option]:bg-slate-900" value={selectedRuleId} onChange={(e) => setSelectedRuleId(e.target.value)}>
                                    {rules.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                                </select>
                            </div>
                            <div className="h-6 w-px bg-slate-700"></div>
                            <div className="flex items-center space-x-2">
                                <button onClick={handleCreateRule} className="px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-500 rounded-full flex items-center text-sm font-medium shadow-lg shadow-indigo-900/50 transition-all hover:scale-105" title="New Rule"><Plus size={16} className="mr-1" /> Create</button>
                                {selectedRuleId && (
                                    <><button onClick={handleDeleteRule} className="p-2 text-slate-500 hover:text-red-400 hover:bg-red-500/10 rounded-full transition-colors"><Trash2 size={18} /></button><div className="w-px h-4 bg-slate-700 mx-1"></div><button onClick={onExportSettings} className="p-2 text-slate-500 hover:text-indigo-400 hover:bg-indigo-500/10 rounded-full transition-colors"><Save size={18} /></button><button onClick={() => fileInputRef.current?.click()} className="p-2 text-slate-500 hover:text-indigo-400 hover:bg-indigo-500/10 rounded-full transition-colors"><Upload size={18} /></button></>
                                )}
                            </div>
                        </div>
                        <div className="flex bg-slate-950 p-1 rounded-lg border border-slate-800">
                            <button onClick={() => setIsDualView(false)} className={`p-2 rounded flex items-center gap-2 text-xs font-bold transition-all ${!isDualView ? 'bg-indigo-600 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}><Maximize size={14} /> Single</button>
                            <button onClick={() => setIsDualView(true)} className={`p-2 rounded flex items-center gap-2 text-xs font-bold transition-all ${isDualView ? 'bg-indigo-600 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}><Columns size={14} /> Split</button>
                        </div>
                        <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleImportFile} />
                    </div>

                    <div className="flex-1 flex flex-col overflow-hidden">
                        {contextView && contextView.isOpen && (
                            <div className="h-1/2 flex flex-col border-b-2 border-indigo-500/50 animate-fade-in-down shrink-0 z-30 relative bg-slate-950">
                                <LogViewerPane fileData={{ name: contextView.name, content: contextView.content }} onFileChange={() => { }} selectedRule={null} placeholderText="Raw Content" isRawMode={true} initialScrollLine={contextView.targetLine} />
                            </div>
                        )}

                        <div className="flex-1 flex overflow-hidden min-h-0">
                            {currentConfig ? (
                                <div className={`${isPanelOpen ? 'w-[500px]' : 'w-12'} bg-gradient-to-br from-slate-900 to-slate-950 border-r border-slate-800 transition-all duration-300 flex flex-col h-full shadow-2xl z-20 custom-scrollbar relative shrink-0`}>
                                    <div className="absolute top-4 right-0 z-30 translate-x-1/2">
                                        <button onClick={() => setIsPanelOpen(!isPanelOpen)} className="w-6 h-6 flex items-center justify-center bg-slate-800 text-slate-400 hover:text-white rounded-full border border-slate-700 shadow-md hover:scale-110 transition-all">{isPanelOpen ? <ChevronLeft size={14} /> : <ChevronRight size={14} />}</button>
                                    </div>
                                    {isPanelOpen ? (
                                        <div className="p-6 overflow-y-auto h-full">
                                            <div className="mb-6">
                                                <label className="block text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1">Mission Name</label>
                                                <input className="w-full bg-slate-800/50 rounded-xl px-2 py-1 text-2xl font-black text-slate-200 focus:outline-none border-b-2 border-transparent focus:border-indigo-500 placeholder-slate-600 transition-all" value={currentConfig.name} onChange={(e) => updateCurrentRule({ name: e.target.value })} placeholder="Untitled Rule" />
                                            </div>
                                            <div className="mb-8">
                                                <div className="flex items-center justify-between mb-4"><label className="text-sm font-bold text-slate-300 flex items-center gap-2"><Zap size={16} className="text-yellow-500 fill-yellow-500" /> Happy Combos</label></div>
                                                <div className="space-y-4">
                                                    {groupedRoots.map(([root, indices], rootIdx) => (
                                                        <div key={rootIdx} className="bg-slate-800/40 rounded-2xl p-4 border border-slate-700/50 flex flex-col gap-2 relative group">

                                                            {/* DELETE GROUP BUTTON */}
                                                            <button onClick={() => { const newGroups = currentConfig.includeGroups.filter((_, i) => !indices.includes(i)); updateCurrentRule({ includeGroups: newGroups }); }} className="absolute top-2 right-2 bg-slate-700 text-slate-400 hover:text-red-400 hover:bg-slate-600 rounded-full p-1 border border-slate-600 opacity-0 group-hover:opacity-100 transition-all z-20" title="Delete Group"> <X size={14} /> </button>

                                                            {/* TOP ROW: ROOT TAG */}
                                                            <div className="flex items-center gap-2 relative z-10 self-start">
                                                                <div className="bg-indigo-600/20 p-1 rounded text-indigo-400"><FolderOpen size={14} /></div>
                                                                {editingTag?.groupIdx === indices[0] && editingTag?.termIdx === 0 ? (
                                                                    <input autoFocus className="bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded-lg text-sm font-bold border border-indigo-500/40 min-w-[80px] outline-none" value={editingTag.value} onChange={(e) => setEditingTag({ ...editingTag, value: e.target.value })}
                                                                        onBlur={() => {
                                                                            const newGroups = [...currentConfig.includeGroups];
                                                                            indices.forEach(idx => newGroups[idx][0] = editingTag.value.trim());
                                                                            updateCurrentRule({ includeGroups: newGroups });
                                                                            setEditingTag(null);
                                                                        }}
                                                                        onKeyDown={(e) => { if (e.key === 'Enter') e.currentTarget.blur(); }}
                                                                    />
                                                                ) : (
                                                                    <div onClick={() => setEditingTag({ groupIdx: indices[0], termIdx: 0, value: root })} className="text-indigo-200 text-sm font-bold cursor-pointer hover:text-white transition-colors border-b border-transparent hover:border-indigo-400">
                                                                        {root || '(Root Tag)'}
                                                                    </div>
                                                                )}
                                                            </div>

                                                            {/* BOTTOM ROW: BRANCHES TREE */}
                                                            <div className="relative pl-6 ml-2.5 flex flex-col gap-2 mt-1">
                                                                {/* Main Vertical Trunk */}
                                                                <div className="absolute left-0 top-[-8px] bottom-4 w-px bg-slate-600"></div>

                                                                {indices.map(originalIdx => {
                                                                    const branchTags = currentConfig.includeGroups[originalIdx].slice(1);
                                                                    return (
                                                                        <div key={originalIdx} className="relative flex flex-col gap-2">
                                                                            {/* Branch Connector (Curve) */}
                                                                            <div className="absolute -left-6 top-[13px] w-6 h-px">
                                                                                {/* Using a pseudo-curve via borders */}
                                                                                <div className="absolute right-0 bottom-0 w-4 h-4 border-l border-b border-slate-600 rounded-bl-xl translate-y-1/2"></div>
                                                                            </div>

                                                                            <div className="flex flex-wrap items-center gap-2 pl-2">
                                                                                {branchTags.map((term, tIdx) => {
                                                                                    if (term.trim() === '' && !(editingTag?.groupIdx === originalIdx && editingTag?.termIdx === tIdx + 1)) return null;
                                                                                    return (
                                                                                        <React.Fragment key={tIdx}>
                                                                                            {tIdx > 0 && <div className="h-0.5 w-3 bg-indigo-500/30 rounded-full"></div>}
                                                                                            {editingTag?.groupIdx === originalIdx && editingTag?.termIdx === tIdx + 1 ? (
                                                                                                <input autoFocus className="bg-slate-700 text-slate-200 px-2 py-1 rounded text-xs font-medium border border-indigo-500 w-20 outline-none" value={editingTag.value} onChange={(e) => setEditingTag({ ...editingTag, value: e.target.value })}
                                                                                                    onBlur={() => {
                                                                                                        const newGroups = [...currentConfig.includeGroups];
                                                                                                        if (editingTag.value.trim()) newGroups[originalIdx][tIdx + 1] = editingTag.value.trim();
                                                                                                        else newGroups[originalIdx] = newGroups[originalIdx].filter((_, i) => i !== tIdx + 1);
                                                                                                        updateCurrentRule({ includeGroups: newGroups });
                                                                                                        setEditingTag(null);
                                                                                                    }}
                                                                                                    onKeyDown={(e) => { if (e.key === 'Enter') e.currentTarget.blur(); }}
                                                                                                />
                                                                                            ) : (
                                                                                                <div onClick={() => setEditingTag({ groupIdx: originalIdx, termIdx: tIdx + 1, value: term })} className="flex items-center bg-slate-900 text-slate-300 px-2 py-1 rounded text-xs border border-slate-700 hover:border-indigo-500 cursor-pointer transition-colors">
                                                                                                    <span>{term}</span>
                                                                                                    <button onClick={(e) => { e.stopPropagation(); const newGroups = [...currentConfig.includeGroups]; newGroups[originalIdx] = newGroups[originalIdx].filter((_, i) => i !== tIdx + 1); updateCurrentRule({ includeGroups: newGroups }); }} className="ml-1 text-slate-500 hover:text-red-400"><X size={10} /></button>
                                                                                                </div>
                                                                                            )}
                                                                                        </React.Fragment>
                                                                                    )
                                                                                })}

                                                                                <input className="w-16 bg-transparent text-xs text-slate-500 placeholder-slate-600 focus:text-slate-200 focus:outline-none border-b border-transparent focus:border-indigo-500 transition-all py-1" placeholder="+ tag"
                                                                                    onKeyDown={(e) => {
                                                                                        if (e.key === 'Enter' && e.currentTarget.value.trim()) {
                                                                                            const newGroups = [...currentConfig.includeGroups];
                                                                                            const cleanGroup = newGroups[originalIdx].filter(t => t !== '');
                                                                                            newGroups[originalIdx] = [...cleanGroup, e.currentTarget.value.trim()];
                                                                                            updateCurrentRule({ includeGroups: newGroups });
                                                                                            e.currentTarget.value = '';
                                                                                        }
                                                                                    }}
                                                                                />

                                                                                {/* Only show delete branch X if there are multiple branches */}
                                                                                {indices.length > 1 && (
                                                                                    <button onClick={() => { const newGroups = currentConfig.includeGroups.filter((_, i) => i !== originalIdx); updateCurrentRule({ includeGroups: newGroups }); }} className="ml-auto text-slate-600 hover:text-red-400 p-1 rounded hover:bg-slate-700" title="Remove Branch"> <X size={12} /> </button>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                    )
                                                                })}

                                                                {/* ADD NEW BRANCH BUTTON (End of Tree) */}
                                                                <div className="relative">
                                                                    {/* Connector for Add Button */}
                                                                    <div className="absolute -left-6 top-[13px] w-6 h-px">
                                                                        <div className="absolute right-0 bottom-0 w-4 h-4 border-l border-b border-slate-600 rounded-bl-xl translate-y-1/2"></div>
                                                                    </div>

                                                                    <div className="pl-2">
                                                                        <button onClick={() => updateCurrentRule({ includeGroups: [...currentConfig.includeGroups, [root, '']] })} className="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-dashed border-slate-600 text-xs font-medium text-slate-500 hover:text-indigo-400 hover:bg-slate-800 hover:border-indigo-500/50 transition-all">
                                                                            <Plus size={12} /> <span>Add Branch</span>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    <button onClick={() => updateCurrentRule({ includeGroups: [...currentConfig.includeGroups, ['NewRoot']] })} className="w-full py-3 border-2 border-dashed border-slate-700 rounded-2xl text-slate-500 hover:bg-slate-800 hover:border-slate-600 hover:text-indigo-400 transition-all flex items-center justify-center text-sm font-bold"><Plus size={18} className="mr-2" /> New Combo Tree</button>
                                                </div>
                                            </div>
                                            <div className="mt-4">
                                                <label className="text-sm font-bold text-slate-300 mb-3 flex items-center gap-2"><ShieldAlert size={16} className="text-red-500" /> Block List</label>
                                                <div className="bg-red-900/10 rounded-2xl p-4 border border-red-900/20 border-dashed relative">
                                                    <div className="flex flex-wrap gap-2">
                                                        {currentConfig.excludes.map((exc, idx) => (exc.trim() !== '' ? (<div key={idx} className="flex items-center bg-red-500/10 text-red-300 px-3 py-1.5 rounded-lg text-sm font-medium border border-red-500/20 shadow-sm"> <span>{exc}</span> <button onClick={() => updateCurrentRule({ excludes: currentConfig.excludes.filter((_, i) => i !== idx) })} className="ml-2 text-red-400/50 hover:text-red-300"><X size={12} /></button> </div>) : null))}
                                                        <input className="bg-slate-700 text-sm text-slate-200 placeholder-slate-400 focus:bg-slate-600 focus:outline-none py-1.5 px-3 rounded-lg border border-slate-700/50 focus:border-red-500/50 transition-colors min-w-[120px]" placeholder="+ block word..." onKeyDown={(e) => { if (e.key === 'Enter' && e.currentTarget.value.trim()) { updateCurrentRule({ excludes: [...currentConfig.excludes.filter(t => t !== ''), e.currentTarget.value.trim()] }); e.currentTarget.value = ''; } }} />
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="mt-8">
                                                <label className="text-sm font-bold text-slate-300 mb-3 flex items-center gap-2"><Highlighter size={16} className="text-pink-400" /> Color Highlights</label>
                                                <div className="bg-slate-800 rounded-2xl p-4 shadow-sm border border-slate-700 mb-2">
                                                    <div className="flex items-center gap-2 mb-4">
                                                        <input ref={highlightInputRef} className="flex-1 bg-slate-700 text-sm text-slate-200 placeholder-slate-400 focus:bg-slate-600 focus:outline-none py-1.5 px-3 rounded-lg border border-slate-700/50 focus:border-pink-500 transition-colors" placeholder="Word to color..." value={newHighlightWord} onChange={(e) => setNewHighlightWord(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && newHighlightWord.trim()) { const h = { id: crypto.randomUUID(), keyword: newHighlightWord.trim(), color: newHighlightColor }; updateCurrentRule({ highlights: [...(currentConfig.highlights || []), h] }); setNewHighlightWord(''); } }} />
                                                        <div className="flex gap-1 flex-wrap max-w-[210px]">
                                                            {HIGHLIGHT_COLORS.map(c => (<button key={c.value} onClick={() => { setNewHighlightColor(c.value); highlightInputRef.current?.focus(); }} className={`w-6 h-6 rounded-full border-2 transition-transform hover:scale-110 ${c.value} ${newHighlightColor === c.value ? 'border-white scale-110 shadow-md' : 'border-transparent opacity-80'}`} title={c.label} />))}
                                                            <label className={`w-6 h-6 rounded-full border-2 transition-transform hover:scale-110 cursor-pointer flex items-center justify-center overflow-hidden bg-slate-700 relative ${isHexColor(newHighlightColor) ? 'border-white scale-110 shadow-md' : 'border-slate-500 opacity-80'}`} title="Custom Color"> {isHexColor(newHighlightColor) && (<div className="absolute inset-0" style={{ backgroundColor: newHighlightColor }}></div>)} <Palette size={12} className={`relative z-10 ${isHexColor(newHighlightColor) ? 'text-white drop-shadow-md' : 'text-slate-400'}`} /> <input type="color" className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" value={isHexColor(newHighlightColor) ? newHighlightColor : '#000000'} onChange={(e) => { setNewHighlightColor(e.target.value); highlightInputRef.current?.focus(); }} /> </label>
                                                        </div>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2">
                                                        {(currentConfig.highlights || []).map((h, i) => { const isHex = isHexColor(h.color); return (<div key={h.id} style={isHex ? { backgroundColor: h.color } : undefined} className={`flex items-center gap-2 px-3 py-1 rounded-lg text-xs font-bold text-slate-900 border border-black/10 ${!isHex ? h.color : ''}`}> {h.keyword} {i < 5 && <span className="text-[9px] opacity-50 ml-1">(#{i + 1})</span>} <button onClick={() => updateCurrentRule({ highlights: (currentConfig.highlights || []).filter(item => item.id !== h.id) })} className="text-slate-800/50 hover:text-black"><X size={12} /></button> </div>); })}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="h-full flex flex-col items-center pt-16 gap-4">
                                            <div className="vertical-text text-slate-500 font-bold tracking-widest text-xs uppercase transform -rotate-180" style={{ writingMode: 'vertical-rl' }}>Configuration</div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="w-[500px] bg-slate-900 border-r border-slate-800 p-6 flex items-center justify-center text-slate-500">Select or Create a Rule</div>
                            )}

                            <div className="flex-1 flex overflow-hidden bg-slate-950">
                                <div className="flex-1 flex overflow-hidden">
                                    {isDualView ? (
                                        <div className="flex w-full h-full">
                                            <LogViewerPane ref={leftPaneRef} fileData={fileLeft} onFileChange={(name, content) => setFileLeft({ name, content })} selectedRule={currentConfig} placeholderText="Drop File A (Left)" hotkeyScope="ctrl" onSyncScroll={handleSyncScroll} onRowDoubleClick={handleRowDoubleClick} />
                                            <div className="w-1 bg-slate-900 hover:bg-indigo-600 transition-colors cursor-col-resize z-30 shadow-xl"></div>
                                            <LogViewerPane ref={rightPaneRef} fileData={fileRight} onFileChange={(name, content) => setFileRight({ name, content })} selectedRule={currentConfig} placeholderText="Drop File B (Right)" hotkeyScope="alt" onSyncScroll={handleSyncScroll} onRowDoubleClick={handleRowDoubleClick} />
                                        </div>
                                    ) : (
                                        <LogViewerPane ref={leftPaneRef} fileData={fileLeft} onFileChange={(name, content) => setFileLeft({ name, content })} selectedRule={currentConfig} placeholderText="Drop Log File Here" hotkeyScope="ctrl" onRowDoubleClick={handleRowDoubleClick} />
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Perf Analyzer Component
        const PerfAnalyzer = ({ defaultUrl, defaultMethod }) => {
            const [url, setUrl] = useState(defaultUrl || 'https://jsonplaceholder.typicode.com/posts/1');
            const [method, setMethod] = useState(defaultMethod || 'GET');
            const [body, setBody] = useState('');
            const [loading, setLoading] = useState(false);
            const [response, setResponse] = useState(null);

            const handleSendRequest = async () => {
                setLoading(true); setResponse(null); const startTime = performance.now();
                try {
                    const options = { method, headers: { 'Content-Type': 'application/json' } };
                    if (['POST', 'PUT', 'PATCH'].includes(method) && body) options.body = body;
                    const res = await fetch(url, options);
                    const endTime = performance.now();
                    const data = await res.json().catch(() => ({ error: 'Could not parse JSON' }));
                    const headers = {}; res.headers.forEach((val, key) => { headers[key] = val; });
                    setResponse({ status: res.status, statusText: res.statusText, headers, data, timeTaken: Math.round(endTime - startTime) });
                } catch (error) { setResponse({ status: 0, statusText: 'Network Error', headers: {}, data: { message: error.message }, timeTaken: 0 }); }
                finally { setLoading(false); }
            };

            const getMethodColor = (m) => {
                switch (m) { case 'GET': return 'text-blue-400 bg-blue-500/10 border-blue-500/30'; case 'POST': return 'text-green-400 bg-green-500/10 border-green-500/30'; case 'DELETE': return 'text-red-400 bg-red-500/10 border-red-500/30'; case 'PUT': return 'text-orange-400 bg-orange-500/10 border-orange-500/30'; default: return 'text-slate-400 bg-slate-800 border-slate-700'; }
            };

            return (
                <div className="flex h-full flex-col bg-slate-950 p-6 gap-6">
                    <div className="bg-slate-900 rounded-3xl p-6 shadow-lg border border-slate-800 shrink-0">
                        <div className="flex items-center justify-between mb-6"><h2 className="text-lg font-bold text-slate-200 flex items-center gap-2"><div className="p-2 bg-indigo-500/20 rounded-xl"> <Activity className="text-indigo-400" size={20} /> </div> Request Composer</h2></div>
                        <div className="flex gap-4">
                            <div className="relative">
                                <select value={method} onChange={(e) => setMethod(e.target.value)} className={`appearance-none h-12 px-4 pr-8 rounded-xl font-bold border cursor-pointer focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all [&>option]:bg-slate-900 [&>option]:text-slate-200 ${getMethodColor(method)}`}> <option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option> </select>
                                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none opacity-50"><ArrowRight size={14} className="text-slate-400" /></div>
                            </div>
                            <div className="flex-1 relative group"><div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-indigo-400 transition-colors"><Globe size={18} /></div><input type="text" value={url} onChange={(e) => setUrl(e.target.value)} placeholder="https://api.example.com/endpoint" className="w-full h-12 pl-12 pr-4 bg-slate-950 border border-slate-800 rounded-xl font-medium text-slate-200 placeholder-slate-600 focus:outline-none focus:bg-slate-900 focus:border-indigo-500 transition-all" /></div>
                            <button onClick={handleSendRequest} disabled={loading} className={`h-12 px-8 rounded-xl flex items-center gap-2 font-bold text-white shadow-lg transition-all hover:scale-105 active:scale-95 ${loading ? 'bg-indigo-900 cursor-wait shadow-none text-indigo-300' : 'bg-indigo-600 hover:bg-indigo-500 shadow-indigo-900/50'}`}> {loading ? <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div> : <Send size={18} />} {loading ? 'Sending' : 'Send'} </button>
                        </div>
                        {['POST', 'PUT', 'PATCH'].includes(method) && (
                            <div className="mt-4 animate-fade-in-down"><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 ml-1">Request Payload</label><div className="relative"><textarea value={body} onChange={(e) => setBody(e.target.value)} className="w-full h-32 bg-slate-950 text-emerald-400 rounded-2xl p-4 font-mono text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 resize-none shadow-inner border border-slate-800" placeholder='{ "key": "value" }' /><div className="absolute top-2 right-2 text-[10px] text-slate-600 font-mono">JSON</div></div></div>
                        )}
                    </div>
                    <div className="flex-1 flex flex-col min-h-0">
                        {response ? (
                            <div className="flex-1 bg-slate-900 rounded-3xl shadow-lg border border-slate-800 overflow-hidden flex flex-col animate-fade-in-up">
                                <div className="bg-slate-800/50 p-4 border-b border-slate-800 flex justify-between items-center backdrop-blur-sm">
                                    <div className="flex items-center gap-4">
                                        <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg font-bold text-sm shadow-sm ${response.status >= 200 && response.status < 300 ? 'bg-green-500/10 text-green-400 border border-green-500/20' : 'bg-red-500/10 text-red-400 border border-red-500/20'}`}><div className={`w-2 h-2 rounded-full ${response.status >= 200 && response.status < 300 ? 'bg-green-500' : 'bg-red-500'}`}></div> {response.status} {response.statusText}</div>
                                        <div className="flex items-center gap-1.5 text-slate-400 text-sm font-medium bg-slate-950 px-3 py-1.5 rounded-lg border border-slate-800 shadow-sm"><Clock size={14} className="text-slate-500" /> {response.timeTaken}ms</div>
                                    </div>
                                </div>
                                <div className="flex-1 flex overflow-hidden relative">
                                    <div className="w-full overflow-auto p-0">
                                        <div className="sticky top-0 bg-slate-900/90 backdrop-blur z-10 px-6 py-2 border-b border-slate-800 flex items-center gap-2"><Database size={14} className="text-slate-500" /><span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Response Data</span></div>
                                        <pre className="p-6 text-sm font-mono text-emerald-400 leading-relaxed whitespace-pre-wrap selection:bg-emerald-900/50 selection:text-emerald-100">{JSON.stringify(response.data, null, 2)}</pre>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center text-slate-500 border-2 border-dashed border-slate-800 rounded-3xl m-2 bg-slate-00/50">
                                <div className="bg-slate-800 p-6 rounded-full shadow-sm mb-4"><Activity size={48} className="text-indigo-400" /></div>
                                <p className="font-medium text-slate-400">Ready to trace request</p>
                                <p className="text-sm text-slate-600 mt-1">Configure and send to view results</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 4. TPK Extractor Component
        const TpkExtractor = () => {
            const [dragActive, setDragActive] = useState(false);
            const [status, setStatus] = useState('IDLE');
            const [fileName, setFileName] = useState('');
            const [resultPath, setResultPath] = useState('');
            const [log, setLog] = useState([]);
            const [progressStep, setProgressStep] = useState(0);

            const addLog = (msg) => setLog(prev => [...prev, `[${new Date().toLocaleTimeString()}] ${msg}`]);
            const handleDrag = useCallback((e) => { e.preventDefault(); e.stopPropagation(); if (e.type === 'dragenter' || e.type === 'dragover') setDragActive(true); else if (e.type === 'dragleave') setDragActive(false); }, []);

            const processFile = async (file) => {
                setStatus('PROCESSING'); setProgressStep(1); setLog([]); setFileName(file.name);
                try {
                    addLog(`Analying file: ${file.name}`); await new Promise(r => setTimeout(r, 800)); setProgressStep(2); addLog("Header detection: RPM v3.0 detected."); await new Promise(r => setTimeout(r, 1000)); setProgressStep(3); addLog("Extracting CPIO payload stream..."); await new Promise(r => setTimeout(r, 1200)); setProgressStep(4); addLog("Expanding CPIO archive..."); await new Promise(r => setTimeout(r, 800)); addLog("Locating TPK package signature...");
                    const canSave = 'showSaveFilePicker' in window;
                    if (canSave) addLog("Browser supports File System Access. Prompting to save TPK..."); else addLog("Browser environment restricted. Preparing download...");
                    setProgressStep(5); setStatus('COMPLETED'); const finalName = file.name.replace('.rpm', '.tpk'); setResultPath(canSave ? `Saved to original folder as ${finalName}` : `Ready to download: ${finalName}`); addLog(`Extraction Complete. TPK ready.`);
                } catch (err) { setStatus('ERROR'); addLog("Error processing file structure."); }
            };

            const handleDrop = useCallback((e) => { e.preventDefault(); e.stopPropagation(); setDragActive(false); if (e.dataTransfer.files && e.dataTransfer.files[0]) { const file = e.dataTransfer.files[0]; if (!file.name.endsWith('.rpm')) { alert("Please drop a valid .rpm file"); return; } processFile(file); } }, []);
            const handleDownload = () => { const dummyContent = "TPK_HEADER_SIGNATURE_MOCK_DATA"; saveFileWithPicker(dummyContent, fileName.replace('.rpm', '.tpk'), 'application/octet-stream'); };
            const steps = [{ id: 1, label: 'Upload' }, { id: 2, label: 'Analyze' }, { id: 3, label: 'Unpack RPM' }, { id: 4, label: 'Expand CPIO' }, { id: 5, label: 'Extract TPK' }];

            return (
                <div className="flex flex-col h-full bg-slate-950 p-8 items-center justify-center">
                    <div className="max-w-3xl w-full bg-slate-900 rounded-3xl shadow-xl border border-slate-800 overflow-hidden flex flex-col relative">
                        <div className="p-8 border-b border-slate-800 bg-gradient-to-r from-orange-900/10 to-slate-900">
                            <div className="flex items-center gap-4 mb-2"><div className="p-3 bg-slate-800 rounded-2xl shadow-sm text-orange-500 border border-slate-700"><Archive size={24} /></div><div><h2 className="text-2xl font-bold text-slate-200">RPM to TPK Converter</h2><p className="text-slate-500 text-sm">Unlocks internal TPK packages from installers</p></div></div>
                        </div>
                        <div className="p-8 min-h-[400px] flex flex-col">
                            {status === 'IDLE' && (
                                <div className={`flex-1 border-4 border-dashed rounded-3xl flex flex-col items-center justify-center transition-all cursor-pointer group relative overflow-hidden ${dragActive ? 'border-orange-500 bg-orange-500/10 scale-[0.98]' : 'border-slate-800 hover:border-orange-500/50 hover:bg-slate-800'}`} onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={handleDrop}>
                                    <div className={`p-6 rounded-full mb-6 transition-all duration-500 ${dragActive ? 'bg-orange-500/20 rotate-12 scale-110' : 'bg-slate-800 group-hover:scale-110'}`}><Box size={48} className={dragActive ? 'text-orange-500' : 'text-slate-600 group-hover:text-orange-400'} /></div><h3 className="text-xl font-bold text-slate-300">Drop RPM File</h3><p className="text-slate-500 mt-2 text-sm font-medium">Drag & Drop to start magic extraction</p>
                                    <div className="absolute -bottom-10 -right-10 w-32 h-32 bg-orange-500/5 rounded-full pointer-events-none blur-2xl"></div><div className="absolute -top-10 -left-10 w-32 h-32 bg-orange-500/5 rounded-full pointer-events-none blur-2xl"></div>
                                </div>
                            )}
                            {(status === 'PROCESSING' || status === 'COMPLETED' || status === 'ERROR') && (
                                <div className="flex-1 flex flex-col">
                                    <div className="flex justify-between items-center mb-10 relative"><div className="absolute top-1/2 left-0 w-full h-1 bg-slate-800 -z-10 rounded-full"><div className="h-full bg-orange-600 transition-all duration-700 rounded-full shadow-[0_0_10px_rgba(234,88,12,0.5)]" style={{ width: `${((progressStep - 1) / (steps.length - 1)) * 100}%` }}></div></div>{steps.map((step) => { const isCompleted = progressStep > step.id; const isCurrent = progressStep === step.id; return (<div key={step.id} className="flex flex-col items-center gap-2"> <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border-2 transition-all duration-500 ${isCompleted || isCurrent ? 'bg-orange-600 border-orange-600 text-white shadow-lg shadow-orange-900/50' : 'bg-slate-900 border-slate-700 text-slate-600'} ${isCurrent ? 'ring-4 ring-orange-500/20 scale-110' : ''}`}>{isCompleted ? <CheckCircle size={14} /> : step.id}</div> <span className={`text-[10px] font-bold uppercase tracking-wider ${isCurrent ? 'text-orange-500' : 'text-slate-600'}`}>{step.label}</span> </div>) })}</div>
                                    <div className="bg-black rounded-xl p-6 font-mono text-xs flex-1 overflow-auto shadow-inner relative mb-6 border border-slate-800"><div className="absolute top-3 right-4 flex gap-1.5"><div className="w-2.5 h-2.5 rounded-full bg-slate-700"></div><div className="w-2.5 h-2.5 rounded-full bg-slate-700"></div><div className="w-2.5 h-2.5 rounded-full bg-slate-700"></div></div><div className="space-y-2 mt-2">{log.map((l, i) => (<div key={i} className="text-emerald-500 opacity-0 animate-fade-in" style={{ animationDelay: `${i * 50}ms`, animationFillMode: 'forwards' }}><span className="text-slate-600 mr-2">$</span>{l}</div>))}{status === 'PROCESSING' && (<div className="text-orange-500 animate-pulse mt-2 flex items-center gap-2"><Cog size={12} className="animate-spin" /> Processing...</div>)}</div></div>
                                    {status === 'COMPLETED' && (<div className="bg-green-500/10 border border-green-500/20 rounded-2xl p-4 flex items-center justify-between animate-fade-in-up"><div className="flex items-center gap-3"><div className="bg-green-500/20 p-2 rounded-full text-green-500"><CheckCircle size={20} /></div><div><p className="font-bold text-green-400">Extraction Successful</p><p className="text-xs text-green-500/70 font-medium opacity-80">{resultPath}</p></div></div><button onClick={handleDownload} className="px-6 py-2.5 bg-green-600 hover:bg-green-500 text-white rounded-xl shadow-lg shadow-green-900/40 text-sm font-bold flex items-center gap-2 transition-all hover:scale-105"><FileDown size={18} /> Download TPK</button></div>)}
                                    {status === 'ERROR' && (<div className="bg-red-500/10 border border-red-500/20 rounded-2xl p-4 flex items-center gap-3"><AlertCircle className="text-red-500" /><span className="text-red-400 font-bold">Extraction Failed. Corrupted Header.</span></div>)}
                                    {(status === 'COMPLETED' || status === 'ERROR') && (<button onClick={() => setStatus('IDLE')} className="mt-6 self-center text-slate-500 hover:text-indigo-400 text-xs font-bold uppercase tracking-widest transition-colors flex items-center gap-2"><ArrowRight size={14} /> Process another file</button>)}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 5. JSON Tools Component
        const JsonTools = () => {
            const [mode, setMode] = useState('FORMATTER');
            const [input, setInput] = useState('');
            const [formatted, setFormatted] = useState('');
            const [error, setError] = useState(null);
            const [valid, setValid] = useState(false);
            const [leftJson, setLeftJson] = useState('');
            const [rightJson, setRightJson] = useState('');
            const [diffResult, setDiffResult] = useState(null);
            const [diffError, setDiffError] = useState(null);

            const handleFormat = () => { if (!input.trim()) { setFormatted(''); setValid(false); setError(null); return; } try { const obj = JSON.parse(input); setFormatted(JSON.stringify(obj, null, 2)); setValid(true); setError(null); } catch (e) { setValid(false); setError(e.message); setFormatted(''); } };
            const handleMinify = () => { if (!input.trim()) return; try { const obj = JSON.parse(input); setFormatted(JSON.stringify(obj)); setValid(true); setError(null); } catch (e) { setValid(false); setError(e.message); } };
            const clearFormatter = () => { setInput(''); setFormatted(''); setError(null); setValid(false); };
            const handleCompare = () => { setDiffError(null); setDiffResult(null); try { let leftObj, rightObj; try { leftObj = JSON.parse(leftJson); } catch (e) { throw new Error("Left JSON is invalid"); } try { rightObj = JSON.parse(rightJson); } catch (e) { throw new Error("Right JSON is invalid"); } const leftStr = JSON.stringify(leftObj, null, 2); const rightStr = JSON.stringify(rightObj, null, 2); setDiffResult({ leftLines: leftStr.split('\n'), rightLines: rightStr.split('\n') }); } catch (e) { setDiffError(e.message); } };
            const highlightJson = (jsonStr) => { if (!jsonStr) return null; return jsonStr.split('\n').map((line, lineIdx) => { const keyMatch = line.match(/^(\s*)(".*?")(\s*:\s*)(.*)$/); if (keyMatch) { const [, indent, key, colon, value] = keyMatch; return (<div key={lineIdx} className="whitespace-pre">{indent}<span className="text-indigo-400 font-bold">{key}</span><span className="text-slate-500">{colon}</span><span className={getValueClass(value)}>{value}</span></div>); } return <div key={lineIdx} className="whitespace-pre text-slate-400">{line}</div>; }); };
            const getValueClass = (val) => { val = val.trim(); if (val.startsWith('"')) return 'text-emerald-400'; if (val === 'true' || val === 'false') return 'text-orange-400'; if (val === 'null') return 'text-red-400'; if (!isNaN(Number(val.replace(',', '')))) return 'text-blue-400'; return 'text-slate-300'; };
            const getDiffCount = () => { if (!diffResult) return 0; return diffResult.leftLines.reduce((count, line, i) => line !== diffResult.rightLines[i] ? count + 1 : count, 0); };

            return (
                <div className="flex h-full flex-col bg-slate-950">
                    <div className="bg-slate-900 border-b border-slate-800 p-4 shrink-0 flex items-center justify-between">
                        <div className="flex items-center bg-slate-950 p-1 rounded-xl border border-slate-800"><button onClick={() => setMode('FORMATTER')} className={`flex items-center gap-2 px-6 py-2 rounded-lg text-sm font-bold transition-all ${mode === 'FORMATTER' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}><Braces size={16} /> Formatter & Validator</button><button onClick={() => setMode('DIFF')} className={`flex items-center gap-2 px-6 py-2 rounded-lg text-sm font-bold transition-all ${mode === 'DIFF' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}><GitCompare size={16} /> Diff Viewer</button></div><div className="text-slate-500 text-xs font-mono bg-slate-800 px-3 py-1 rounded-full border border-slate-700">JSON Tools v0.0.2</div>
                    </div>
                    <div className="flex-1 overflow-hidden p-6 relative">
                        {mode === 'FORMATTER' && (
                            <div className="flex h-full gap-6">
                                <div className="flex-1 flex flex-col gap-2"><div className="flex justify-between items-center text-slate-400 px-2"><span className="text-xs font-bold uppercase tracking-wider">Raw Input</span><div className="flex gap-2"><button onClick={clearFormatter} className="p-1 hover:text-red-400 transition-colors" title="Clear"><Trash2 size={14} /></button></div></div><textarea className={`flex-1 bg-slate-900 rounded-2xl border p-4 font-mono text-sm text-slate-300 focus:outline-none focus:ring-1 resize-none shadow-inner custom-scrollbar ${error ? 'border-red-500/50 focus:ring-red-500' : 'border-slate-800 focus:ring-indigo-500'}`} placeholder="Paste your JSON here..." value={input} onChange={(e) => setInput(e.target.value)} spellCheck={false} /><div className="flex gap-3 mt-2"><button onClick={handleFormat} className="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-indigo-900/30 transition-transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2"><AlignLeft size={16} /> Beautify</button><button onClick={handleMinify} className="px-6 bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 rounded-xl font-bold text-sm border border-slate-700 transition-colors flex items-center gap-2"><Minimize2 size={16} /> Minify</button></div></div>
                                <div className="flex-1 flex flex-col gap-2"><div className="flex justify-between items-center text-slate-400 px-2"><span className="text-xs font-bold uppercase tracking-wider flex items-center gap-2">{valid ? <span className="text-green-500 flex items-center gap-1"><CheckCircle size={12} /> Valid JSON</span> : error ? <span className="text-red-500 flex items-center gap-1"><AlertCircle size={12} /> Invalid JSON</span> : 'Formatted Output'}</span><button onClick={() => { if (formatted) { navigator.clipboard.writeText(formatted); alert("Copied!"); } }} disabled={!valid} className="p-1 hover:text-indigo-400 transition-colors disabled:opacity-30" title="Copy Result"><Copy size={14} /></button></div><div className="flex-1 bg-slate-950 rounded-2xl border border-slate-800 p-4 font-mono text-sm overflow-auto custom-scrollbar relative shadow-inner">{error ? (<div className="text-red-400 p-2 bg-red-500/10 rounded-lg border border-red-500/20"><strong>Error parsing JSON:</strong><br />{error}</div>) : formatted ? (<div className="text-sm leading-6">{highlightJson(formatted)}</div>) : (<div className="h-full flex flex-col items-center justify-center text-slate-600"><FileJson size={48} className="mb-4 opacity-50" /><p>Ready to format</p></div>)}</div></div>
                            </div>
                        )}
                        {mode === 'DIFF' && (
                            <div className="flex flex-col h-full gap-4">
                                <div className="h-1/3 flex gap-4 min-h-[150px]"><div className="flex-1 flex flex-col"><label className="text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Original JSON</label><textarea className="flex-1 bg-slate-900 rounded-xl border border-slate-800 p-3 font-mono text-xs text-slate-400 focus:outline-none focus:border-indigo-500 resize-none" value={leftJson} onChange={(e) => setLeftJson(e.target.value)} placeholder='{"a": 1}' /></div><div className="flex items-center justify-center"><button onClick={handleCompare} className="bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-full shadow-lg shadow-indigo-900/50 transition-transform hover:scale-110 active:scale-95" title="Compare"><ArrowRightLeft size={24} /></button></div><div className="flex-1 flex flex-col"><label className="text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Modified JSON</label><textarea className="flex-1 bg-slate-900 rounded-xl border border-slate-800 p-3 font-mono text-xs text-slate-400 focus:outline-none focus:border-indigo-500 resize-none" value={rightJson} onChange={(e) => setRightJson(e.target.value)} placeholder='{"a": 2}' /></div></div>
                                <div className="flex-1 bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden flex flex-col"><div className="bg-slate-800/50 px-4 py-2 border-b border-slate-800 flex justify-between items-center"><div className="flex items-center gap-3"><span className="text-xs font-bold text-slate-400 uppercase tracking-wider">Comparison Result</span>{diffResult && (<span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${getDiffCount() > 0 ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}>{getDiffCount()} Lines Different</span>)}</div>{diffError && <span className="text-xs text-red-400 font-bold bg-red-500/10 px-2 py-1 rounded">{diffError}</span>}</div><div className="flex-1 overflow-auto custom-scrollbar p-2">{diffResult ? (<div className="flex font-mono text-xs"><div className="flex-1 border-r border-slate-800 pr-2">{diffResult.leftLines.map((line, i) => { const rightLine = diffResult.rightLines[i]; const isDiff = line !== rightLine; return (<div key={i} className={`flex px-2 ${isDiff ? 'bg-red-500/10' : ''}`}><span className={`w-8 select-none text-right mr-4 ${isDiff ? 'text-red-400 font-bold' : 'text-slate-600'}`}>{i + 1}</span><span className={`whitespace-pre-wrap break-all ${isDiff ? 'text-red-300' : 'text-slate-400'}`}>{line}</span></div>); })}</div><div className="flex-1 pl-2">{diffResult.rightLines.map((line, i) => { const leftLine = diffResult.leftLines[i]; const isDiff = line !== leftLine; return (<div key={i} className={`flex px-2 ${isDiff ? 'bg-green-500/10' : ''}`}><span className={`w-8 select-none text-right mr-4 ${isDiff ? 'text-green-400 font-bold' : 'text-slate-600'}`}>{i + 1}</span><span className={`whitespace-pre-wrap break-all ${isDiff ? 'text-green-300' : 'text-slate-400'}`}>{line}</span></div>); })}</div></div>) : (<div className="h-full flex items-center justify-center text-slate-700 flex-col gap-2"><GitCompare size={32} opacity={0.5} /><p>Enter JSON logs and click compare</p></div>)}</div></div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 6. MAIN APP COMPONENT
        const App = () => {
            const [activeTool, setActiveTool] = useState(ToolId.LOG_EXTRACTOR);
            const [logRules, setLogRules] = useState([
                { id: '1', name: 'Error Logs', includeGroups: [['ERROR'], ['Exception']], excludes: ['Test', 'Debug'], highlights: [{ id: 'h1', keyword: 'ERROR', color: 'bg-red-400' }, { id: 'h2', keyword: 'Exception', color: 'bg-orange-400' }] }
            ]);
            const [lastApiUrl, setLastApiUrl] = useState('');
            const [lastMethod, setLastMethod] = useState('GET');
            const [toolOrder, setToolOrder] = useState([ToolId.LOG_EXTRACTOR, ToolId.PERF_ANALYZER, ToolId.JSON_TOOLS, ToolId.TPK_EXTRACTOR]);

            useEffect(() => {
                const saved = localStorage.getItem('devtool_suite_settings');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.logRules) {
                            const migratedRules = parsed.logRules.map((r) => {
                                let rule = { ...r };
                                if (rule.includes && !rule.includeGroups) {
                                    rule.includeGroups = Array.isArray(rule.includes) ? rule.includes.map((i) => [i]) : [[]];
                                    delete rule.includes;
                                }
                                if (!rule.highlights) rule.highlights = [];
                                return rule;
                            });
                            setLogRules(migratedRules);
                        }
                        if (parsed.lastEndpoint) setLastApiUrl(parsed.lastEndpoint);
                    } catch (e) { console.error("Failed to load settings", e); }
                }
                const savedOrder = localStorage.getItem('devtool_suite_tool_order');
                if (savedOrder) { try { setToolOrder(JSON.parse(savedOrder)); } catch (e) { } }
            }, []);

            useEffect(() => {
                const settings = { logRules, lastEndpoint: lastApiUrl, lastMethod };
                localStorage.setItem('devtool_suite_settings', JSON.stringify(settings));
            }, [logRules, lastApiUrl, lastMethod]);

            useEffect(() => { localStorage.setItem('devtool_suite_tool_order', JSON.stringify(toolOrder)); }, [toolOrder]);

            const handleExportSettings = () => {
                const settings = { logRules, lastEndpoint: lastApiUrl, lastMethod };
                const jsonStr = JSON.stringify(settings, null, 2);
                saveFileWithPicker(jsonStr, 'happytool_settings.json', 'application/json');
            };

            const handleImportSettings = (settings) => {
                if (settings.logRules) {
                    const migratedRules = settings.logRules.map((r) => {
                        let rule = { ...r };
                        if (rule.includes && !rule.includeGroups) {
                            rule.includeGroups = Array.isArray(rule.includes) ? rule.includes.map((i) => [i]) : [[]];
                            delete rule.includes;
                        }
                        if (!rule.highlights) rule.highlights = [];
                        return rule;
                    });
                    setLogRules(migratedRules);
                }
                if (settings.lastEndpoint) setLastApiUrl(settings.lastEndpoint);
                if (settings.lastMethod) setLastMethod(settings.lastMethod);
            };

            const handleReorderTools = (newOrder) => setToolOrder(newOrder);

            const renderContent = () => {
                switch (activeTool) {
                    case ToolId.LOG_EXTRACTOR: return <LogExtractor rules={logRules} onUpdateRules={setLogRules} onExportSettings={handleExportSettings} onImportSettings={handleImportSettings} />;
                    case ToolId.PERF_ANALYZER: return <PerfAnalyzer defaultUrl={lastApiUrl} defaultMethod={lastMethod} />;
                    case ToolId.JSON_TOOLS: return <JsonTools />;
                    case ToolId.TPK_EXTRACTOR: return <TpkExtractor />;
                    default: return <div className="p-8 text-slate-400">Select a tool from the sidebar</div>;
                }
            };

            return (
                <div className="flex flex-col h-screen w-screen overflow-hidden bg-slate-950">
                    <div className="flex-1 flex overflow-hidden">
                        <Sidebar activeTool={activeTool} onSelectTool={setActiveTool} toolOrder={toolOrder} onReorderTools={handleReorderTools} />
                        <main className="flex-1 overflow-hidden relative bg-slate-950">{renderContent()}</main>
                    </div>
                </div>
            );
        };

        const rootElement = document.getElementById('root');
        if (rootElement) {
            const root = ReactDOM.createRoot(rootElement);
            root.render(<React.StrictMode><App /></React.StrictMode>);
        }
    </script>
    <script type="module" src="/index.tsx"></script>
</body>

</html>